<p align="center">
<img src="./www/buildomat_wide.png" alt="hammer logo"><br>
<b>B U I L D O M A T</b><br>
a software build labour-saving device<br>
</p>

<hr>

Buildomat manages the provisioning of ephemeral UNIX systems (e.g., instances
in AWS EC2) on which to run software builds.  It logs job output, collects
build artefacts, and reports status.  The system integrates with GitHub through
the Checks API, to allow build jobs to be triggered by pushes and pull
requests.

## Components

### Buildomat Core

The buildomat core is responsible for authenticating users and remote services,
for managing build systems, and for running jobs and collecting output.

#### Client Command (`buildomat`, in `client/`)

A client tool that uses the client library to interface with and manipulate the
core server.  The tool has both administrative and user-level functions,
expressed in a relatively regular hierarchy of commands; e.g., `buildomat job
run` or `buildomat user ls`.

```
$ ./target/release/buildomat
Usage: buildomat [OPTS] COMMAND [ARGS...]

Commands:
    info                get information about server and user account
    control             server control functions
    job                 job management
    user                user management


Options:
        --help          usage information
    -p, --profile PROFILE
                        authentication and server profile

ERROR: choose a command
```

#### Client Library (`buildomat-openapi`, in `openapi/`)

A HTTP client library for accessing the core buildomat server.  This client is
regenerated by a script (`./tools/generate.sh`) which uses the
[`progenitor`](https://github.com/oxidecomputer/progenitor) OpenAPI client
generator.

#### Server (`buildomat-server`, in `server/`)

The core buildomat API server.  Manages the creation, tracking, and destruction
of AWS EC2 instances as required to execute jobs.  This component can be used
by both the GitHub integration server (Wollongong) and the client command.

#### Agent (`buildomat-agent`, in `agent`/)

A process that is injected into an ephemeral AWS EC2 instance to allow the
buildomat core server to take control and run jobs.  This process receives
single-use credentials at provisioning time from the core server, and connects
out to receive instructions.  The agent does not require a public IP, or any
direct inbound connectivity, to allow agents to run inside remote NAT
environments.

### GitHub Integration (Wollongong)

Wollongong is the GitHub-specific portion of the buildomat suite.  It is
responsible for receiving and processing notifications of new commits and pull
requests on GitHub, starting any configured build jobs, and reporting the
results so that they are visible through the GitHub user interface.

#### Server (`wollongong-server`, in `github/server/`)

This server acts as a [GitHub App](https://docs.github.com/en/developers/apps).
It is responsible for processing incoming [GitHub
webhooks](https://docs.github.com/en/developers/webhooks-and-events/webhooks/about-webhooks)
that notify the system about commits and pull requests in authorised
repositories.  In addition to relaying jobs between GitHub and the buildomat
core, this service provides an additional HTML presentation of job state (e.g.,
detailed logs) and access to any artefacts that jobs produce.  This server
keeps state required to manage the interaction with GitHub, but does not store
job data; requests for logs or artefacts are proxied back to the core server.

#### Database Tool (`wollongong-dbtool`, in `github/dbtool/`)

This tool can be used to inspect the database state kept by Wollongong as it
tracks GitHub pull requests and commits.  Unlike the core client tool, this
program directly interacts with a local SQLite database.

```
$ wollongong-dbtool
Usage: wollongong-dbtool COMMAND [ARGS...]

Commands:
    delivery (del)      webhook deliveries
    repository (repo)   GitHub repositories
    check               GitHub checks


Options:
    --help              usage information

ERROR: choose a command
```

Of particular note, the tool is useful for inspecting and replaying received
webhook events; e.g.,

```
$ wollongong-dbtool del ls
SEQ   ACK RECVTIME             EVENT          ACTION
0     1   2021-10-05T01:58:32Z ping           -
1     1   2021-10-05T02:25:33Z installation   created
2     1   2021-10-05T02:26:53Z push
3     1   2021-10-05T02:26:53Z check_suite    requested
4     1   2021-10-05T02:26:56Z check_suite    completed
5     1   2021-10-05T02:26:56Z check_run      completed
6     1   2021-10-05T02:26:56Z check_run      created
7     1   2021-10-05T02:26:56Z check_run      created
8     1   2021-10-05T02:26:57Z check_run      created
...
```

The `wollongong-dbtool del unack SEQ` command can be used to trigger the
reprocessing of an invididual webhook message.

## Per-repository Configuration

Buildomat works as a [GitHub App](https://docs.github.com/en/developers/apps),
which is generally "installed" at the level of an
[Organisation](https://docs.github.com/en/organizations).  Installing the App
allows buildomat to receive notifications about events, such as git pushes and
pull requests, from all repositories (public and private) within the
organisation.  In order to avoid accidents, buildomat requires that the service
be explicitly configured for a repository before it will take any actions.

Per-repository configuration is achieved by creating a file in the default
branch of the repository in question, named `.github/buildomat/config.toml`.
This file is written in [TOML](https://toml.io/), with a handful of simple
values.  Supported properties in this file include:

- `enable` **(boolean)**

  Must be present and have the value `true` in order for buildomat to consider
  the repository for jobs; e.g.,

  ```toml
  enable = true
  ```

- `org_only` **(boolean, defaults to `true` if missing)**

  If set to `true`, or missing from the file, buildomat will not automatically
  run jobs in response to pull requests opened by users that are not a member
  of the GitHub Organisation which owns the repository.  If set to `false`, any
  GitHub user can cause a job to be executed.

  This property is important for security if your repository is able to create
  any jobs that have access to secrets, or to restricted networks.

- `allow_users` **(array of strings, each a GitHub login name)**

  If specified, jobs will be started automatically for users in this list,
  regardless of whether they are a member of the Organisation that owns the
  repository or not, and regardless of the value of the `org_only` property.

  This is often useful for pre-authorising jobs driven by Pull Requests
  made by various automated systems; e.g.,

  ```toml
  allow_users = [
          "dependabot[bot]",
          "renovate[bot]",
  ]
  ```

Note that buildomat will only ever read this configuration file from the most
recent commit in the default branch of the repository, not from the contents of
another branch or pull request.  This is of particular importance for
security-sensitive properties like `org_only`, where the policy set by users
with full write access to the repository must not be overridden by changes from
potentially untrusted users.  If a pull request with a malicious policy change
is merged, it will then be in the default branch and active for subsequent pull
requests; maintainers must carefully review pull requests that change this
file.

## Licence

Unless otherwise noted, all components are licenced under the [Mozilla Public
License Version 2.0](./LICENSE).
